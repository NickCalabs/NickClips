{% extends "layout.html" %}

{% block title %}Video Share - Upload or Share Videos{% endblock %}

{% block content %}
<div class="px-4 py-5 my-5 text-center">
    <h1 class="display-5 fw-bold">Share Your Videos</h1>
    <div class="col-lg-8 mx-auto">
        <p class="lead mb-4">
            Upload videos or share them from other platforms in seconds.
            Get a shareable link instantly.
        </p>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto bg-white rounded p-4">
        <ul class="nav nav-tabs upload-nav mb-4" id="uploadTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button" role="tab" aria-controls="url-panel" aria-selected="true">
                    <i class="fas fa-link me-2"></i>From URL
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" aria-controls="upload-panel" aria-selected="false">
                    <i class="fas fa-upload me-2"></i>Upload Video
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="uploadTabsContent">
            <!-- URL Tab Panel -->
            <div class="tab-pane fade show active" id="url-panel" role="tabpanel" aria-labelledby="url-tab">
                <div class="mb-3">
                    <label for="url-input" class="form-label">Video URL</label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="url-input" placeholder="https://youtube.com/watch?v=..." aria-label="Video URL">
                        <button class="btn btn-primary" type="button" id="download-url-btn">Download</button>
                    </div>
                    <div class="form-text">
                        Enter a URL from YouTube, Twitter, Vimeo, and many other platforms.
                    </div>
                </div>
                
                <div class="mt-4">
                    <h5>Supported platforms include:</h5>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <span class="badge text-bg-light border"><i class="fab fa-youtube me-1 text-danger"></i>YouTube</span>
                        <span class="badge text-bg-light border"><i class="fab fa-twitter me-1 text-info"></i>Twitter</span>
                        <span class="badge text-bg-light border"><i class="fab fa-vimeo me-1 text-primary"></i>Vimeo</span>
                        <span class="badge text-bg-light border"><i class="fab fa-facebook me-1 text-primary"></i>Facebook</span>
                        <span class="badge text-bg-light border"><i class="fab fa-instagram me-1 text-danger"></i>Instagram</span>
                        <span class="badge text-bg-light border"><i class="fab fa-tiktok me-1"></i>TikTok</span>
                        <span class="badge text-bg-light border"><i class="fab fa-twitch me-1 text-purple"></i>Twitch</span>
                        <span class="badge text-bg-light border"><i class="fab fa-reddit me-1 text-danger"></i>Reddit</span>
                        <span class="badge text-bg-light border"><i class="fas fa-ellipsis-h me-1"></i>Many more...</span>
                    </div>
                </div>
            </div>
            
            <!-- Upload Tab Panel -->
            <div class="tab-pane fade" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
                <div class="upload-area" id="drop-area">
                    <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 3rem;"></i>
                    <h4>Drag and drop your video file here</h4>
                    <p>or</p>
                    <div class="mb-3">
                        <input class="form-control" type="file" id="file-input" name="file" accept=".mp4,.mov,.avi,.mkv,.webm,.flv,.wmv">
                    </div>
                    <button type="button" id="upload-file-btn" class="btn btn-primary px-4 py-2">
                        <i class="fas fa-upload me-2"></i>Upload Video
                    </button>
                    <p class="text-muted small mt-3">
                        Maximum file size: 1GB<br>
                        Supported formats: MP4, MOV, AVI, MKV, WEBM, FLV, WMV
                    </p>
                </div>
            </div>
        </div>
        
        <div id="upload-progress" class="mt-4 d-none">
            <div class="progress" style="height: 25px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
            <p id="upload-status" class="text-center mt-2">Uploading...</p>
        </div>
        
        <div id="download-status" class="alert alert-info d-none"></div>
        
        <div class="mt-4 d-none" id="platforms-container">
            <h5>Supported platforms include:</h5>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <span class="badge text-bg-light border"><i class="fab fa-youtube me-1 text-danger"></i>YouTube</span>
                <span class="badge text-bg-light border"><i class="fab fa-twitter me-1 text-info"></i>Twitter</span>
                <span class="badge text-bg-light border"><i class="fab fa-vimeo me-1 text-primary"></i>Vimeo</span>
                <span class="badge text-bg-light border"><i class="fab fa-facebook me-1 text-primary"></i>Facebook</span>
                <span class="badge text-bg-light border"><i class="fab fa-instagram me-1 text-danger"></i>Instagram</span>
                <span class="badge text-bg-light border"><i class="fab fa-tiktok me-1"></i>TikTok</span>
                <span class="badge text-bg-light border"><i class="fab fa-twitch me-1 text-purple"></i>Twitch</span>
                <span class="badge text-bg-light border"><i class="fab fa-reddit me-1 text-danger"></i>Reddit</span>
                <span class="badge text-bg-light border"><i class="fas fa-ellipsis-h me-1"></i>Many more...</span>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-4">
        <div class="text-center">
            <div class="feature-icon bg-primary text-white mb-3 p-3 rounded-circle mx-auto" style="width: 60px; height: 60px;">
                <i class="fas fa-bolt" style="font-size: 1.5rem;"></i>
            </div>
            <h3>Fast Processing</h3>
            <p>Videos are processed quickly and efficiently with a high-quality MP4 output.</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <div class="feature-icon bg-primary text-white mb-3 p-3 rounded-circle mx-auto" style="width: 60px; height: 60px;">
                <i class="fas fa-share-alt" style="font-size: 1.5rem;"></i>
            </div>
            <h3>Easy Sharing</h3>
            <p>Get a short, easy-to-share link instantly, even before processing is complete.</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <div class="feature-icon bg-primary text-white mb-3 p-3 rounded-circle mx-auto" style="width: 60px; height: 60px;">
                <i class="fas fa-laptop" style="font-size: 1.5rem;"></i>
            </div>
            <h3>Works Everywhere</h3>
            <p>Videos include proper preview tags for Discord, iMessage, and social media platforms.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const urlInput = document.getElementById('url-input');
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const downloadUrlBtn = document.getElementById('download-url-btn');
    const downloadStatus = document.getElementById('download-status');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const uploadStatus = document.getElementById('upload-status');
    
    // Download URL button
    if (downloadUrlBtn) {
        downloadUrlBtn.addEventListener('click', function() {
            handleUrlSubmit();
        });
    }
    
    // URL input for auto-submission
    urlInput.addEventListener('paste', function(e) {
        // Wait a moment to get the pasted content
        setTimeout(() => {
            if (urlInput.value.trim()) {
                handleUrlSubmit();
            }
        }, 100);
    });
    
    // Handle URL submission on Enter key
    urlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && urlInput.value.trim()) {
            e.preventDefault();
            handleUrlSubmit();
        }
    });
    
    function handleUrlSubmit() {
        const url = urlInput.value.trim();
        if (!url) return;
        
        // Show download status
        downloadStatus.classList.remove('d-none');
        downloadStatus.classList.remove('alert-danger');
        downloadStatus.classList.add('alert-info');
        downloadStatus.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Validating and downloading URL...</div>';
        
        // Disable the button
        downloadUrlBtn.disabled = true;
        downloadUrlBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        // Call API to download video from URL
        fetch('/api/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                downloadStatus.classList.remove('alert-info');
                downloadStatus.classList.add('alert-danger');
                downloadStatus.textContent = data.error || 'An error occurred';
                
                // Re-enable the button
                downloadUrlBtn.disabled = false;
                downloadUrlBtn.textContent = 'Download';
            } else {
                // Success - redirect to dashboard instead of showing error
                window.location.href = '/dashboard';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            downloadStatus.classList.remove('alert-info');
            downloadStatus.classList.add('alert-danger');
            downloadStatus.textContent = 'An error occurred while processing your request.';
            
            // Re-enable the button
            downloadUrlBtn.disabled = false;
            downloadUrlBtn.textContent = 'Download';
        });
    }
    
    // File upload handling
    uploadFileBtn.addEventListener('click', function() {
        if (!fileInput.files || fileInput.files.length === 0) {
            showAlert('Please select a file to upload.', 'warning');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        // Show upload progress
        uploadProgress.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        uploadStatus.textContent = 'Uploading...';
        
        // Upload the file
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload', true);
        
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
                uploadStatus.textContent = `Uploading: ${percentComplete}%`;
            }
        };
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    uploadStatus.textContent = 'Upload complete!';
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    
                    // Redirect to video page after a short delay
                    setTimeout(() => {
                        window.location.href = `/video/${response.slug}`;
                    }, 1000);
                } else {
                    uploadStatus.textContent = `Error: ${response.error}`;
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                }
            } else {
                uploadStatus.textContent = 'Upload failed.';
                progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                progressBar.classList.add('bg-danger');
            }
        };
        
        xhr.onerror = function() {
            uploadStatus.textContent = 'Upload failed.';
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-danger');
        };
        
        xhr.send(formData);
    });
    
    // Drag and drop handling
    if (dropArea && fileInput) {
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                if (files[0].name) {
                    // Show the file name in the UI
                    const fileName = files[0].name;
                    dropArea.querySelector('h4').textContent = `Selected: ${fileName}`;
                }
            }
        }
    }
    
    // Helper function to show alerts
    function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alerts-container');
        if (!alertContainer) {
            console.error('Alerts container not found');
            return;
        }
        
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} alert-dismissible fade show`;
        alertEl.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.appendChild(alertEl);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertEl.classList.remove('show');
            setTimeout(() => alertEl.remove(), 300);
        }, 5000);
    }
</script>
{% endblock %}
